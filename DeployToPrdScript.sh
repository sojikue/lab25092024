#!/bin/bash

# Переменная для тега версии
TAG_VERSION=$1

# Проверка, передан ли параметр с версией
if [ -z "$TAG_VERSION" ]; then
  echo "Ошибка: необходимо передать тег версии. Пример использования: ./deploy_to_prd.sh v1.0.0"
  exit 1
fi

# Переключаемся на ветку dev
echo "Переключаемся на ветку dev..."
git checkout dev

# Подтягиваем последние изменения из удаленной ветки dev
echo "Подтягиваем последние изменения из ветки dev..."
git pull origin dev

# Переключаемся на ветку prd
echo "Переключаемся на ветку prd..."
git checkout prd

# Подтягиваем последние изменения из удаленной ветки prd
echo "Подтягиваем последние изменения из ветки prd..."
git pull origin prd

# Мержим ветку dev в ветку prd
echo "Мержим ветку dev в prd..."
git merge dev

# Проверяем, произошли ли конфликты
if [ $? -ne 0 ]; then
  echo "Возникли конфликты при слиянии. Пожалуйста, разрешите их и повторите попытку."
  exit 1
fi

# Создаем тег с переданной версией
echo "Создаем тег версии $TAG_VERSION..."
git tag -a "$TAG_VERSION" -m "Release $TAG_VERSION"

# Пушим изменения в ветку prd
echo "Отправляем изменения и тег в удаленный репозиторий..."
git push origin prd
git push origin "$TAG_VERSION"

echo "Перенос завершен успешно. Тег $TAG_VERSION установлен."
